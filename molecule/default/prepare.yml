---
# AIDEV-NOTE: The prepare step runs on the controller (localhost) to build and
# install the collection from source, making the FQCN available to converge.
- name: Prepare - install collection from source
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_dir: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}"
  tasks:
    - name: Remove stale tarballs
      ansible.builtin.find:
        paths: "{{ project_dir }}"
        patterns: "linsomniac-fsbuilder-*.tar.gz"
      register: stale_tarballs

    - name: Delete stale tarballs
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ stale_tarballs.files }}"

    - name: Build collection tarball
      ansible.builtin.command:
        cmd: ansible-galaxy collection build --force
        chdir: "{{ project_dir }}"
      changed_when: true

    - name: Find built tarball
      ansible.builtin.find:
        paths: "{{ project_dir }}"
        patterns: "linsomniac-fsbuilder-*.tar.gz"
      register: tarball_files

    - name: Assert exactly one tarball found
      ansible.builtin.assert:
        that:
          - tarball_files.files | length == 1
        fail_msg: "Expected 1 tarball, found {{ tarball_files.files | length }}"

    - name: Install collection from tarball
      ansible.builtin.command:
        cmd: >-
          ansible-galaxy collection install
          {{ tarball_files.files[0].path }}
          -p {{ project_dir }}/test-collections
          --force
      changed_when: true

    - name: Clean up tarball
      ansible.builtin.file:
        path: "{{ tarball_files.files[0].path }}"
        state: absent
